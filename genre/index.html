<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="./movieTile.css">
  </head>
<body>
<header>
  EasyFlix/genre
</header>
<section>

    <div id="response"></div>
    <script type="text/javascript">
    const options = {
      method: 'GET',
      headers: {
        accept: 'application/json',
        Authorization: 'Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiIxNzQzYWQ4NWM1MTU1NmUzZDgyMDliYzkwMWVlNzY0NiIsIm5iZiI6MTczMzc0NTkxNy40OTQwMDAyLCJzdWIiOiI2NzU2ZGNmZDZlMGJlZDI2NmI3ZmFiM2QiLCJzY29wZXMiOlsiYXBpX3JlYWQiXSwidmVyc2lvbiI6MX0.3eEChcFzcTubHssYx6QAOY3yIJlmisJQWH3ynQS7uEA'
      }
    };
    let hrfString = window.location.href.toString();
    let url = new URL(hrfString);
    let genreParam = url.searchParams.get("genre");
    const divElement = document.getElementById("response");
    var pages;
    var loadedPages;
    function sleep(milliseconds) {
      const date = Date.now();
      let currentDate = null;
      do {
        currentDate = Date.now();
      } while (currentDate - date < milliseconds);
    }

    fetch('https://api.themoviedb.org/3/discover/movie?include_adult=false&include_video=false&language=en-US&page=1&sort_by=popularity.desc&with_genres='+genreParam, options)
    .then(res => res.json())
    .then(res => {
      pages = res.total_pages;
      console.log(res.total_pages);
    console.log(pages);
    for(let i=1;i<=10;i++)
    {


       fetch('https://api.themoviedb.org/3/discover/movie?include_adult=false&include_video=false&language=en-US&page='+i+'&sort_by=popularity.desc&with_genres='+genreParam, options)
      .then(res2 => res2.json())
      .then(res2 => {
        let poster_path;
        let poster_path_arr = [];
        let movieTitle_arr = [];
        let movie_title;

        for (const xx in res2) {

          for (const yy in res2[xx]) {

            poster_path_arr[poster_path_arr.length] = res2[xx][yy].poster_path;
            movieTitle_arr[movieTitle_arr.length] = res2[xx][yy].title;
            //console.log(res2[xx][yy].title);
            const newNode = document.createElement("div");
            divElement.appendChild(newNode);
            newNode.setAttribute("class","movieTile");
            newNode.id = "Movie_P"+i+"_N"+yy;
            newNode.style.size="750px 500px";
            newNode.style.background="darkred";

            const movieCover = document.createElement("img");
            newNode.appendChild(movieCover);
            movieCover.class = "movieCoverClass";
            movieCover.style.size="100% 100%";
            movieCover.src = "https://image.tmdb.org/t/p/w500"+res2[xx][yy].poster_path;

            const movieTitle = document.createElement("h1");
            newNode.appendChild(movieTitle);
            movieTitle.textContent=res2[xx][yy].title;
            }
          }

      })

     .catch(err => console.error(err));

     if((i-1)%40==0){
       sleep(120);
       console.log("halted for 120ms");
     }
     loadedPages=i;
    }
    })

    .catch(err => console.error(err));
    function addPage(str,options)
    {
      fetch(str,options)
     .then(res2 => res2.json())
     .then(res2 => {
       let poster_path;
       let poster_path_arr = [];
       let movieTitle_arr = [];
       let movie_title;

       for (const xx in res2) {

         for (const yy in res2[xx]) {

           poster_path_arr[poster_path_arr.length] = res2[xx][yy].poster_path;
           movieTitle_arr[movieTitle_arr.length] = res2[xx][yy].title;
           //console.log(res2[xx][yy].title);
           const newNode = document.createElement("div");
           divElement.appendChild(newNode);
           newNode.setAttribute("class","movieTile");
           newNode.id = "Movie_P"+(loadedPages+1)+"_N"+yy;
           newNode.style.size="500px 750px";
           newNode.style.background="darkred";

           const movieCover = document.createElement("img");
           newNode.appendChild(movieCover);
           movieCover.class = "movieCoverClass";
           movieCover.style.size="100% 100%";
           movieCover.src = "https://image.tmdb.org/t/p/w500"+res2[xx][yy].poster_path;

           const movieTitle = document.createElement("h1");
           newNode.appendChild(movieTitle);
           movieTitle.textContent=res2[xx][yy].title;
           }
         }
         loadedPages+=1;
         addPageCallback = true;
     })
     .catch(err => console.error(err));
    }


    var addPageCallback = true; //not actually a callback, it's used to prevent duplicates from loading.
    window.onscroll = function(ev) {
    if ((window.innerHeight + Math.round(window.scrollY)) >= document.body.offsetHeight) {
        // you're at the bottom of the page => load next page!
        if(loadedPages<pages && addPageCallback)
          {
            console.log("load more pages");
            addPageCallback = false;
            addPage('https://api.themoviedb.org/3/discover/movie?include_adult=false&include_video=false&language=en-US&page='+(loadedPages+1)+'&sort_by=popularity.desc&with_genres='+genreParam, options);
          }
    }
};
    </script>
  </section>
</body>
</html>
